<template>
	<v-col sm="auto" class="pr-2 pb-2">
		<v-menu
			v-model="menu"
			:close-on-content-click="false"
			:nudge-width="70"
			:max-width="350"
			offset-y
			nudge-bottom="15"
		>
			<template v-slot:activator="{ on, attrs }">
				<v-btn v-bind="attrs" class="text-caption menu-content-btn" color="white" elevation="0" v-on="on">
					<span class="font-weight-bold">Status</span>
					<v-sheet
						v-if="selectedFields.length"
						color="white"
						class="text-no-wrap menu-content ml-2 pr-1"
						rounded
					>
						<v-chip
							v-for="(fieldOption, index) in selectedFields"
							:key="fieldOption"
							class="mx-1 white text-caption"
							style="text-transform: none !important;"
							close
							:ripple="false"
							@click:close="removeItemFromSelection(index)"
						>
							{{ getText(fieldOption) }}
						</v-chip>
					</v-sheet>
					<v-icon right>{{ mdiChevronDown }}</v-icon>
				</v-btn>
			</template>

			<v-card>
				<v-card-text>
					<div class="text-h7 font-weight-bold mb-5">
						Status
					</div>
					<v-checkbox
						v-for="fieldOption in filterOptions"
						:key="fieldOption"
						v-model="selectedOptions"
						:value="fieldOption"
						color="primary"
						:ripple="false"
						:label="getText(fieldOption)"
						class="ma-0"
						dense
					></v-checkbox>
				</v-card-text>
				<v-divider></v-divider>
				<v-card-actions>
					<v-btn color="grey" btn-class="text-caption" text @click="clearAllOptions()">
						Clear
					</v-btn>
					<v-spacer></v-spacer>
					<v-btn
						:disabled="!disableSelectBtn"
						color="primary"
						btn-class="text-caption"
						text
						@click="updateTable()"
					>
						Select
					</v-btn>
				</v-card-actions>
			</v-card>
		</v-menu>
	</v-col>
</template>

<script lang="ts">
import Vue from 'vue';
import { mdiChevronDown } from '@mdi/js';
import { VulnerabilityStatus } from '@/domains/vulnerability/vulnerability.types';

export default Vue.extend({
	name: 'FilterByStatus',
	data() {
		return {
			filterOptions: [VulnerabilityStatus.OPEN, VulnerabilityStatus.FIXED, VulnerabilityStatus.INVALID] as Array<
				VulnerabilityStatus
			>,
			menu: false,
			mdiChevronDown: mdiChevronDown,
			selectedOptions: [VulnerabilityStatus.OPEN] as Array<VulnerabilityStatus>,
			selectedFields: [VulnerabilityStatus.OPEN] as Array<VulnerabilityStatus>
		};
	},
	computed: {
		disableSelectBtn(): boolean {
			return !!this.selectedOptions.length;
		}
	},

	methods: {
		clearAllOptions() {
			this.selectedOptions = [];
			if (this.selectedFields.length) {
				this.updateSelectedOptions();
			}
		},
		updateTable() {
			this.updateSelectedOptions();
			this.menu = false;
		},
		removeItemFromSelection(index: number) {
			this.selectedOptions.splice(index, 1);
			this.updateSelectedOptions();
		},
		updateSelectedOptions() {
			this.selectedFields = Array.from(this.selectedOptions);
			this.$emit('filtersChangeFieldValue', this.selectedOptions);
		},
		getText(status: VulnerabilityStatus): string {
			switch (status) {
				case VulnerabilityStatus.FIXED:
					return 'Fixed';
				case VulnerabilityStatus.INVALID:
					return 'Invalid';
				case VulnerabilityStatus.OPEN:
					return 'Open';
			}
			return '';
		}
	}
});
</script>
<style lang="scss" scoped>
.menu-content {
	max-width: 50vw;
	overflow: hidden;

	&:after {
		content: '';
		position: absolute;
		border-radius: 4px;
		right: 22px;
		width: 20px;
		height: 100%;
		pointer-events: none;
		background-image: linear-gradient(to right, rgba(255, 255, 255, 0), rgba(255, 255, 255, 1));
	}

	&-btn {
		&:hover:before {
			opacity: 0 !important;
		}
	}
}
</style>
