<template>
	<v-card elevation="1">
		<v-card-title>Info</v-card-title>
		<div class="ml-4">
			<v-row>
				<v-col lg="1" md="2" sm="3">
					Status:
				</v-col>
				<v-col lg="11" md="10" sm="9">
					{{ statusText }}
				</v-col>
			</v-row>
			<v-row>
				<v-col lg="1" md="2" sm="3">
					Severity:
				</v-col>
				<v-col lg="11" md="10" sm="9">
					<v-chip :color="severityColor" class="flex-fill flex-grow-0">{{ severity }}</v-chip>
				</v-col>
			</v-row>
			<v-row>
				<v-col lg="1" md="2" sm="3">
					First Detected:
				</v-col>
				<v-col lg="11" md="10" sm="9">
					{{ firstDetectedFormatted }}
				</v-col>
			</v-row>
			<v-row>
				<v-col lg="1" md="2" sm="3">
					Last Detected:
				</v-col>
				<v-col lg="11" md="10" sm="9">
					{{ lastDetectedFormatted }}
				</v-col>
			</v-row>
			<v-row>
				<v-col lg="1" md="2" sm="3">
					Detected on Agents:
				</v-col>
				<v-col lg="11" md="10" sm="9">
					<v-badge
						v-for="agent in detectedOnAgents"
						:key="agent.id"
						:color="getAgentBadgeColor(agent.lastSeen)"
						dot
					>
						<a @click="$router.push({ name: 'agent-details', params: { agentId: agent.id } })">{{
							agent.name
						}}</a>
					</v-badge>
				</v-col>
			</v-row>
		</div>
	</v-card>
</template>

<script lang="ts">
import { PropType } from 'vue';
import { VulnerabilityStatus } from '@/domains/vulnerability/vulnerability.types';
import { Agent } from '@/domains/agent/agent.types';
import moment from 'moment';
import AgentMixings from '@/common/mixin/agent-mixin';

export default AgentMixings.extend({
	name: 'VulnerabilityInfo',
	props: {
		severity: { default: '', type: String },
		firstDetected: { default: '', type: String },
		lastDetected: { default: '', type: String },
		detectedOnAgents: { default: null, type: Array as PropType<Array<Agent>> },
		status: { default: 'Open', type: String }
	},
	computed: {
		statusText(): string {
			if (this.status === VulnerabilityStatus.OPEN) {
				return 'Open';
			} else if (this.status === VulnerabilityStatus.FIXED) {
				return 'Fixed';
			} else if (this.status === VulnerabilityStatus.INVALID) {
				return 'Invalid';
			}
			return '';
		},
		severityColor(): string {
			if (this.severity === 'HIGH') {
				return 'red';
			} else if (this.severity === 'MODERATE') {
				return 'orange';
			} else {
				return 'grey';
			}
		},
		firstDetectedFormatted(): string {
			return moment
				.utc(this.firstDetected)
				.local()
				.format('YYYY-MM-DD HH:mm:ss');
		},
		lastDetectedFormatted(): string {
			return moment
				.utc(this.lastDetected)
				.local()
				.format('YYYY-MM-DD HH:mm:ss');
		}
	}
});
</script>
